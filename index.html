<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Explicitly allow user scaling (pinch to zoom) with generous limits -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0, user-scalable=yes">
    <title>Excel Search Tool - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Use System Fonts for native readability */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .highlight {
            background-color: #fef08a; /* yellow-200 */
            color: #000;
            padding: 2px 4px;
            border-radius: 4px;
            border: 2px solid #eab308;
            display: inline-block;
            font-weight: 900;
        }
        .custom-checkbox {
            accent-color: #2563eb;
            width: 24px; 
            height: 24px;
            cursor: pointer;
        }
        /* Sortable Header Styles */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        th.sortable:hover {
            background-color: #e2e8f0;
        }
        th.sortable .sort-icon {
            font-size: 0.8em;
            margin-left: 6px;
            color: #94a3b8;
        }
        th.sortable.asc .sort-icon::after { content: '\f0de'; font-family: "Font Awesome 6 Free"; font-weight: 900; color: #2563eb; }
        th.sortable.desc .sort-icon::after { content: '\f0dd'; font-family: "Font Awesome 6 Free"; font-weight: 900; color: #2563eb; }
        th.sortable .sort-icon::after { content: '\f0dc'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <div class="max-w-[1800px] mx-auto p-3 md:p-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-900 flex items-center gap-3">
                    <i class="fa-solid fa-file-excel text-green-600"></i>
                    Excel Search Tool <span class="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-1 rounded">Ver 12.0</span>
                </h1>
                <p class="text-slate-500 mt-1 text-sm font-medium">Add/Remove Files • Sortable • Smart Formatting</p>
            </div>
             <div id="globalStatus" class="text-xs font-bold text-slate-400 px-3 py-1 bg-slate-100 rounded-full hidden">
                Ready
            </div>
        </div>

        <!-- Control Panel -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            
            <!-- 1. Upload File -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 text-lg font-bold">1</span>
                        <label class="block text-lg font-bold text-slate-900">Manage Files</label>
                    </div>
                    <span id="fileCountBadge" class="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full hidden">0 Files</span>
                </div>
                
                <div class="relative group mb-3">
                    <label for="fileInput" class="flex items-center justify-center w-full px-4 py-3 bg-blue-50 text-blue-700 font-bold rounded-lg border-2 border-blue-100 border-dashed cursor-pointer hover:bg-blue-100 hover:border-blue-300 transition-all">
                        <i class="fa-solid fa-plus mr-2"></i> Add Excel Files
                    </label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm" multiple class="hidden">
                </div>

                <!-- Visual File List (Interactive) -->
                <div id="fileListContainer" class="flex-1 min-h-[100px] max-h-[200px] overflow-y-auto border border-slate-100 rounded-lg bg-slate-50 p-2 hidden">
                    <ul id="fileList" class="space-y-2"></ul>
                </div>
                
                <p id="fileStats" class="text-sm text-slate-500 font-medium mt-2 hidden text-center">No file loaded</p>
            </div>

            <!-- 2. Search Config -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                <div class="flex items-center gap-2 mb-3">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 text-lg font-bold">2</span>
                    <label class="block text-lg font-bold text-slate-900">Search Config</label>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">Column</label>
                        <select id="searchColumn" class="w-full rounded-lg border-slate-300 border bg-white px-3 py-3 text-base font-bold text-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 disabled:bg-slate-100 disabled:text-slate-400" disabled>
                            <option>Wait for file...</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">Mode</label>
                        <select id="searchMode" class="w-full rounded-lg border-slate-300 border bg-white px-3 py-3 text-base font-bold text-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            <option value="1">1 Keyword</option>
                            <option value="2">2 Keywords (AND)</option>
                            <option value="3">3 Keywords (AND)</option>
                            <option value="4">Exact Phrase</option>
                            <option value="hospital">Hospital (Intent)</option>
                        </select>
                    </div>
                </div>

                <div id="keywordInputs" class="space-y-3 overflow-y-auto max-h-[160px] pr-1">
                    <!-- Dynamic inputs go here -->
                </div>
            </div>

            <!-- 3. Output Settings -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                <div class="flex items-center gap-2 mb-3">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 text-lg font-bold">3</span>
                    <label class="block text-lg font-bold text-slate-900">Output</label>
                </div>
                
                <div class="mb-4">
                    <div class="relative">
                        <button id="toggleColumnsBtn" class="w-full text-left bg-slate-50 border border-slate-300 text-slate-900 text-base font-bold rounded-lg px-3 py-3 flex justify-between items-center hover:bg-slate-100 transition-colors" disabled>
                            <span>Select Output Columns</span>
                            <i class="fa-solid fa-chevron-down text-sm"></i>
                        </button>
                        <div id="columnDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-60 overflow-y-auto p-2 space-y-1"></div>
                    </div>
                </div>

                <!-- Font Size Selector -->
                <div class="mb-4">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">Result Font Size</label>
                    <select id="fontSizeSelect" class="w-full rounded-lg border-slate-300 border bg-white px-3 py-2 text-base font-bold text-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="text-sm">Small</option>
                        <option value="text-[26px]" selected>Large</option>
                    </select>
                </div>

                <!-- Checkboxes -->
                <div class="grid grid-cols-1 gap-y-3 gap-x-2 mb-4">
                    <label class="flex items-center space-x-3 cursor-pointer group bg-slate-50 p-2 rounded hover:bg-slate-100 transition-colors border border-transparent hover:border-slate-200">
                        <input type="checkbox" id="keepLine" checked class="custom-checkbox">
                        <span class="text-base font-semibold text-slate-700 group-hover:text-slate-900">Keep only matching line</span>
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-3 cursor-pointer group bg-slate-50 p-2 rounded border border-transparent">
                            <input type="checkbox" id="appendContact" class="custom-checkbox">
                            <span class="text-sm font-semibold text-slate-700">Append Phone</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer group bg-slate-50 p-2 rounded border border-transparent">
                            <input type="checkbox" id="createNumbers" checked class="custom-checkbox">
                            <span class="text-sm font-semibold text-slate-700">New Phone Col</span>
                        </label>
                    </div>
                     <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-3 cursor-pointer group bg-slate-50 p-2 rounded border border-transparent">
                            <input type="checkbox" id="dropDuplicates" checked class="custom-checkbox">
                            <span class="text-sm font-semibold text-slate-700">Drop Dup Rows</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer group bg-slate-50 p-2 rounded border border-transparent">
                            <input type="checkbox" id="dedupNumbers" checked class="custom-checkbox">
                            <span class="text-sm font-semibold text-slate-700">De-dup Phones</span>
                        </label>
                    </div>
                </div>

                <button onclick="processFile()" id="searchBtn" disabled
                    class="mt-auto w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed text-lg">
                    <i class="fa-solid fa-magnifying-glass"></i> Run Search
                </button>
            </div>

        </div>

        <!-- Results Area -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden min-h-[600px]">
            
            <!-- Result Toolbar -->
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <h2 class="text-lg font-bold text-slate-800">Results</h2>
                    <span id="resultStatus" class="text-sm font-bold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-md">
                        Waiting...
                    </span>
                    <span id="sortStatus" class="text-xs text-slate-400 hidden md:inline-block italic">
                        Click headers to sort
                    </span>
                </div>
                <div id="downloadButtons" class="hidden flex gap-2">
                    <button onclick="downloadHTML()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-800 text-base font-bold py-2 px-4 rounded-lg shadow-sm transition-colors">
                        HTML
                    </button>
                    <button onclick="downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white text-base font-bold py-2 px-4 rounded-lg shadow-sm transition-colors">
                        Excel
                    </button>
                </div>
            </div>

            <!-- Result Table Container -->
            <div class="flex-1 overflow-auto p-0 relative w-full">
                <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white">
                    <div class="bg-slate-50 p-8 rounded-full mb-4">
                        <i class="fa-solid fa-table-cells text-5xl text-slate-300"></i>
                    </div>
                    <p class="text-lg font-bold text-slate-500">Data will appear here</p>
                    <p class="text-base text-slate-400 mt-1">Upload and Search</p>
                </div>
                
                <table id="resultTable" class="min-w-full divide-y divide-slate-300 hidden border-collapse">
                    <thead class="bg-slate-100 sticky top-0 z-10 shadow-sm ring-1 ring-slate-900/5">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <!-- Default to 26px (Large) initially -->
                    <tbody id="tableBody" class="bg-white divide-y divide-slate-200 text-[26px] font-bold text-slate-800 leading-relaxed"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
// State Management
let fileCache = []; // Stores objects: { id, name, data (array), headers (array) }
let combinedData = []; // The merged dataset used for searching
let combinedHeaders = []; // The active headers
let results = [];
let outputCols = [];
let currentSort = { col: -1, dir: 'asc' };

// Hospital Intent Keywords
const HOSPITAL_INTENT = [
    "running hospital","operational hospital","functional hospital","existing hospital",
    "hospital with beds","hospital beds","bed hospital","speciality hospital",
    "multispeciality hospital","hospital land","hospital plot","hospital building",
    "hospital structure","hospital structure only","hospital approved land",
    "land for hospital","reserved for hospital","medical land",
    "institutional land hospital","hospital for sale","hospital available","hospital property",
    "nursing home", "clinic space", "medical center"
];

// UI References
const fileInput = document.getElementById("fileInput");
const fileListContainer = document.getElementById("fileListContainer");
const fileList = document.getElementById("fileList");
const fileCountBadge = document.getElementById("fileCountBadge");
const searchMode = document.getElementById("searchMode");
const keywordInputsDiv = document.getElementById("keywordInputs");
const searchColumnSel = document.getElementById("searchColumn");
const columnDropdown = document.getElementById("columnDropdown");
const toggleColumnsBtn = document.getElementById("toggleColumnsBtn");
const searchBtn = document.getElementById("searchBtn");
const resultStatus = document.getElementById("resultStatus");
const downloadButtons = document.getElementById("downloadButtons");
const tableBody = document.getElementById("tableBody");
const tableHeader = document.getElementById("tableHeader");
const resultTable = document.getElementById("resultTable");
const emptyState = document.getElementById("emptyState");
const globalStatus = document.getElementById("globalStatus");
const fontSizeSelect = document.getElementById("fontSizeSelect");

// Initialize
renderKeywordInputs();

// --- Event Listeners ---
searchMode.addEventListener("change", renderKeywordInputs);

toggleColumnsBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    columnDropdown.classList.toggle("hidden");
    const icon = toggleColumnsBtn.querySelector("i");
    icon.classList.toggle("fa-chevron-down");
    icon.classList.toggle("fa-chevron-up");
});

document.addEventListener("click", (e) => {
    if (!toggleColumnsBtn.contains(e.target) && !columnDropdown.contains(e.target)) {
        columnDropdown.classList.add("hidden");
        const icon = toggleColumnsBtn.querySelector("i");
        icon.classList.remove("fa-chevron-up");
        icon.classList.add("fa-chevron-down");
    }
});

fileInput.addEventListener("change", handleFileAdd);

fontSizeSelect.addEventListener("change", function() {
    const sizeClasses = ["text-sm", "text-[26px]"];
    tableBody.classList.remove(...sizeClasses);
    tableBody.classList.add(this.value);
});


// --- Functions ---

function renderKeywordInputs() {
    keywordInputsDiv.innerHTML = "";
    const mode = searchMode.value;
    
    if (mode === "hospital") {
        const info = document.createElement("div");
        info.className = "text-base font-medium text-blue-700 bg-blue-50 p-3 rounded-lg border border-blue-200 flex items-start gap-2";
        info.innerHTML = `<i class="fa-solid fa-info-circle mt-1"></i> <span>Searching for ${HOSPITAL_INTENT.length} hospital terms.</span>`;
        keywordInputsDiv.appendChild(info);
        return;
    }

    const count = (mode === "4") ? 1 : parseInt(mode);
    for (let i = 1; i <= count; i++) {
        const inp = document.createElement("input");
        inp.className = "keyword-input block w-full rounded-lg border-slate-300 border bg-white px-3 py-3 text-lg font-medium focus:border-blue-500 focus:ring-1 focus:ring-blue-500 placeholder-slate-400";
        inp.placeholder = (mode === "4") ? "Exact phrase..." : `Keyword ${i}...`;
        keywordInputsDiv.appendChild(inp);
    }
}

// 1. Handle "Add Files" (Appending Logic)
async function handleFileAdd(e) {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    // Loading State
    globalStatus.textContent = "Reading...";
    globalStatus.classList.remove("hidden");
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';

    // Read newly added files
    const readFile = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    // Separate Headers and Data
                    let fileHeaders = [];
                    let fileData = [];
                    if (json.length > 0) {
                        fileHeaders = json[0].map(h => String(h || "").trim());
                        fileData = json.slice(1); // Exclude header row from data storage
                    }

                    resolve({ 
                        id: Date.now() + Math.random().toString(36), // Unique ID
                        name: file.name, 
                        headers: fileHeaders,
                        data: fileData, 
                        totalRows: fileData.length
                    });
                } catch (err) {
                    reject({ name: file.name, error: err });
                }
            };
            reader.readAsArrayBuffer(file);
        });
    };

    try {
        const newFilesData = await Promise.all(Array.from(files).map(f => readFile(f)));
        
        // Add to global cache
        fileCache = [...fileCache, ...newFilesData];
        
        // Reset Input (allows selecting same file again if needed, or new files)
        fileInput.value = ""; 

        // Update Everything
        recalculateCombinedData();
        renderFileList();

    } catch (error) {
        console.error(error);
        alert("Error reading some files.");
    }
}

// 2. Remove File
function removeFile(id) {
    fileCache = fileCache.filter(f => f.id !== id);
    recalculateCombinedData();
    renderFileList();
}

// 3. Recalculate Combined Data from Cache
function recalculateCombinedData() {
    if (fileCache.length === 0) {
        combinedData = [];
        combinedHeaders = [];
        resetUI();
        return;
    }

    // Use headers from the *first* uploaded file as master headers
    combinedHeaders = fileCache[0].headers;
    let headerMismatch = false;

    // Concatenate Data
    // NOTE: This assumes columns align. It checks header names to warn user.
    combinedData = [];
    
    // Add Header Row first (for internal logic consistency if needed, though we process data separately usually)
    // Actually, processFile expects workbookData[0] to be headers.
    combinedData.push(combinedHeaders);

    fileCache.forEach(fileObj => {
        // Validation
        if (JSON.stringify(fileObj.headers) !== JSON.stringify(combinedHeaders)) {
            headerMismatch = true;
        }
        combinedData = combinedData.concat(fileObj.data);
    });

    // Update UI based on new combined data
    workbookData = combinedData; // Sync global used by search
    headers = combinedHeaders;   // Sync global used by search

    if (workbookData.length > 1) {
        populateSearchColumns();
        populateOutputCheckboxes();
        
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Run Search';
        toggleColumnsBtn.disabled = false;
        searchColumnSel.disabled = false;
        
        const totalRows = workbookData.length - 1; // minus header
        resultStatus.textContent = `${totalRows} rows ready.`;
        
        if (headerMismatch) {
            globalStatus.textContent = "Header Mismatch";
            globalStatus.className = "text-xs font-bold text-yellow-800 px-3 py-1 bg-yellow-100 rounded-full";
            alert("Warning: Column headers do not match across all files. Results may be inaccurate.\n\nPlease ensure all Excel files have the same structure.");
        } else {
            globalStatus.textContent = "Ready";
            globalStatus.className = "text-xs font-bold text-green-700 px-3 py-1 bg-green-100 rounded-full";
        }
    } else {
        resetUI();
    }
}

// 4. Render File List UI
function renderFileList() {
    fileList.innerHTML = "";
    if (fileCache.length === 0) {
        fileListContainer.classList.add("hidden");
        fileCountBadge.classList.add("hidden");
        return;
    }

    fileListContainer.classList.remove("hidden");
    fileCountBadge.textContent = `${fileCache.length} Files`;
    fileCountBadge.classList.remove("hidden");

    fileCache.forEach(f => {
        const li = document.createElement("li");
        li.className = "flex justify-between items-center bg-white p-2 rounded border border-slate-200 shadow-sm";
        li.innerHTML = `
            <div class="flex items-center overflow-hidden">
                <i class="fa-regular fa-file-excel text-green-600 mr-2 flex-shrink-0"></i> 
                <span class="text-sm font-medium truncate text-slate-700" title="${f.name}">${f.name}</span>
                <span class="ml-2 text-xs text-slate-400">(${f.totalRows} rows)</span>
            </div>
            <button onclick="removeFile('${f.id}')" class="text-slate-400 hover:text-red-500 p-1 ml-2 transition-colors" title="Remove file">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        `;
        fileList.appendChild(li);
    });
}

function resetUI() {
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Run Search';
    toggleColumnsBtn.disabled = true;
    toggleColumnsBtn.innerHTML = `<span>Select Output Columns</span><i class="fa-solid fa-chevron-down text-sm"></i>`;
    searchColumnSel.disabled = true;
    searchColumnSel.innerHTML = "<option>Wait for file...</option>";
    globalStatus.classList.add("hidden");
    resultStatus.textContent = "Waiting...";
}

// --- Standard Search Functions (Unchanged logic, referencing updated globals) ---

function populateSearchColumns() {
    // Save previous selection if possible
    const prevSelection = searchColumnSel.value;
    
    searchColumnSel.innerHTML = "";
    headers.forEach((h, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = h || `Col ${i+1}`;
        searchColumnSel.appendChild(opt);
        
        const lowerH = h.toLowerCase();
        if (lowerH.includes("content") || lowerH.includes("description") || lowerH === "text") {
            searchColumnSel.value = i;
        }
    });
    
    // Restore selection if valid index
    if(prevSelection && prevSelection < headers.length) {
        searchColumnSel.value = prevSelection;
    }
}

function populateOutputCheckboxes() {
    // We want to preserve checked state if headers haven't changed drastically
    // For simplicity, we just re-render. User might have to re-select.
    columnDropdown.innerHTML = "";
    
    const selectAllDiv = document.createElement("div");
    selectAllDiv.className = "flex items-center p-3 hover:bg-slate-50 rounded-lg cursor-pointer border-b border-slate-100 mb-1";
    selectAllDiv.innerHTML = `
        <input type="checkbox" id="selectAllCols" class="rounded text-blue-600 focus:ring-blue-500 border-slate-300 mr-4 w-6 h-6" checked>
        <label for="selectAllCols" class="text-base font-bold text-slate-800 cursor-pointer uppercase">Select All</label>
    `;
    columnDropdown.appendChild(selectAllDiv);

    headers.forEach((h, i) => {
        const div = document.createElement("div");
        div.className = "flex items-center p-3 hover:bg-slate-50 rounded-lg cursor-pointer";
        div.innerHTML = `
            <input type="checkbox" value="${i}" class="col-checkbox rounded text-blue-600 focus:ring-blue-500 border-slate-300 mr-4 w-6 h-6" checked>
            <label class="text-base font-medium text-slate-700 cursor-pointer truncate select-none">${h || `Column ${i+1}`}</label>
        `;
        div.addEventListener("click", (e) => {
             if(e.target.tagName !== 'INPUT') {
                 const cb = div.querySelector('input');
                 cb.checked = !cb.checked;
                 updateColumnButtonText();
             } else {
                 updateColumnButtonText();
             }
        });
        columnDropdown.appendChild(div);
    });

    const selectAllCb = document.getElementById("selectAllCols");
    selectAllCb.addEventListener("change", (e) => {
        const checks = document.querySelectorAll(".col-checkbox");
        checks.forEach(c => c.checked = e.target.checked);
        updateColumnButtonText();
    });

    updateColumnButtonText();
}

function updateColumnButtonText() {
    const checked = document.querySelectorAll(".col-checkbox:checked");
    const total = document.querySelectorAll(".col-checkbox").length;
    
    const btnSpan = toggleColumnsBtn.querySelector("span");
    if (checked.length === 0) btnSpan.textContent = "Select Output Columns";
    else if (checked.length === total) btnSpan.textContent = "All Columns Selected";
    else btnSpan.textContent = `${checked.length} Columns`;
}

function extractNumbers(text, dedup) {
    if (!text) return "";
    const matches = String(text).match(/(?:\+?\d{1,4}[\s-]?)?\(?\d{2,5}\)?[\s-]?\d{3,4}[\s-]?\d{3,4}/g) || [];
    let nums = matches.map(m => m.replace(/[^\d+]/g, '').trim()).filter(n => n.length > 6);
    if (dedup) {
        nums = [...new Set(nums)];
    }
    return nums.join(", ");
}

function toSentenceCase(str) {
    if (!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
}

function processFile() {
    const colIdx = parseInt(searchColumnSel.value);
    const mode = searchMode.value;
    
    const keepLine = document.getElementById("keepLine").checked;
    const appendContact = document.getElementById("appendContact").checked;
    const createNumbers = document.getElementById("createNumbers").checked;
    const dropDuplicates = document.getElementById("dropDuplicates").checked;
    const dedupNumbers = document.getElementById("dedupNumbers").checked;

    let keys = [];
    if (mode === "hospital") {
        keys = HOSPITAL_INTENT;
    } else {
        const inputs = document.querySelectorAll(".keyword-input");
        inputs.forEach(inp => {
            if (inp.value.trim()) keys.push(inp.value.trim().toLowerCase());
        });
    }

    if (keys.length === 0 && keepLine) {
        alert("Please enter at least one keyword.");
        return;
    }

    const checkedBoxes = document.querySelectorAll(".col-checkbox:checked");
    outputCols = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

    results = [];
    const seenRows = new Set();

    // Loop starts at 1 because 0 is headers in workbookData
    for (let i = 1; i < workbookData.length; i++) {
        const row = workbookData[i];
        if (!row) continue;
        
        const cellValue = row[colIdx];
        const cellText = String(cellValue || "").toLowerCase();
        
        let isMatch = false;

        if (mode === "hospital") {
            isMatch = keys.some(k => cellText.includes(k));
        } else if (mode === "4") {
            if (keys.length > 0) isMatch = cellText.includes(keys[0]);
        } else {
            if (keys.length > 0) {
                isMatch = keys.every(k => cellText.includes(k));
            } else {
                isMatch = true; 
            }
        }

        if (keepLine && !isMatch) continue;

        let formattedText = toSentenceCase(String(cellValue || ""));
        
        if (isMatch && keys.length > 0) {
            const sortedKeys = [...keys].sort((a,b) => b.length - a.length);
            const pattern = new RegExp(`(${sortedKeys.map(escapeRegExp).join("|")})`, "gi");
            
            formattedText = formattedText.replace(pattern, (match) => {
                return `<span class="highlight">${match.toUpperCase()}</span>`;
            });
        }
        
        if (appendContact) {
            const nums = extractNumbers(cellValue, dedupNumbers);
            if (nums) {
                const appendStr = ` (Extracted: ${nums})`;
                formattedText += `<span class="text-slate-500 font-bold text-lg ml-2 block mt-1">${appendStr}</span>`;
            }
        }

        const outRow = [];
        const rowSignature = outputCols.map(c => row[c]).join("|");
        
        if (dropDuplicates && seenRows.has(rowSignature)) continue;
        if (dropDuplicates) seenRows.add(rowSignature);

        outputCols.forEach(idx => {
            if (idx === colIdx) {
                outRow.push({ html: formattedText, text: toSentenceCase(String(cellValue || "")) });
            } else {
                const val = String(row[idx] || "");
                const prettyVal = toSentenceCase(val);
                outRow.push({ html: prettyVal, text: prettyVal });
            }
        });

        if (createNumbers) {
            const phones = extractNumbers(cellValue, dedupNumbers); 
            outRow.push({ html: phones, text: phones });
        }

        results.push(outRow);
    }

    displayResults(createNumbers);
}

function sortResults(colIndex) {
    if (currentSort.col === colIndex) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.col = colIndex;
        currentSort.dir = 'asc';
    }

    const dirMultiplier = currentSort.dir === 'asc' ? 1 : -1;

    results.sort((rowA, rowB) => {
        const textA = (rowA[colIndex]?.text || "").toLowerCase();
        const textB = (rowB[colIndex]?.text || "").toLowerCase();
        
        if (textA < textB) return -1 * dirMultiplier;
        if (textA > textB) return 1 * dirMultiplier;
        return 0;
    });

    displayResults(document.getElementById("createNumbers").checked);
}

function displayResults(hasNumbers) {
    let headerHTML = "";
    outputCols.forEach((idx, loopIndex) => {
        let sortClass = "sortable";
        if (currentSort.col === loopIndex) {
            sortClass += currentSort.dir === 'asc' ? " asc" : " desc";
        }
        
        headerHTML += `<th onclick="sortResults(${loopIndex})" class="${sortClass} px-6 py-4 text-left text-lg font-extrabold text-slate-700 uppercase tracking-wider bg-slate-100 border-b border-slate-300 whitespace-nowrap">
            ${headers[idx]} <span class="sort-icon"></span>
        </th>`;
    });

    if (hasNumbers) {
        const phoneColIndex = outputCols.length;
        let sortClass = "sortable";
        if (currentSort.col === phoneColIndex) {
            sortClass += currentSort.dir === 'asc' ? " asc" : " desc";
        }
        headerHTML += `<th onclick="sortResults(${phoneColIndex})" class="${sortClass} px-6 py-4 text-left text-lg font-extrabold text-slate-700 uppercase tracking-wider bg-slate-100 border-b border-slate-300 whitespace-nowrap">
            Extracted Numbers <span class="sort-icon"></span>
        </th>`;
    }
    
    tableHeader.innerHTML = headerHTML;

    if (results.length === 0) {
        resultTable.classList.add("hidden");
        emptyState.classList.remove("hidden");
        resultStatus.textContent = "No matches found.";
        downloadButtons.classList.add("hidden");
        return;
    }

    emptyState.classList.add("hidden");
    resultTable.classList.remove("hidden");
    
    const rowsHTML = results.map(row => {
        return `<tr class="hover:bg-slate-50 transition-colors">` + 
               row.map(cell => `<td class="px-6 py-6 whitespace-normal min-w-[200px] border-b border-slate-200">${cell.html}</td>`).join("") + 
               `</tr>`;
    }).join("");

    tableBody.innerHTML = rowsHTML;
    resultStatus.textContent = `${results.length} matches`;
    downloadButtons.classList.remove("hidden");
}

function downloadHTML() {
    const tableClone = resultTable.cloneNode(true);
    tableClone.classList.remove("hidden");
    
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Search Results</title>
            <style>
                body { font-family: -apple-system, system-ui, sans-serif; padding: 20px; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 22px; }
                th { background-color: #f2f2f2; font-weight: 800; }
                .highlight { background-color: yellow; font-weight: 900; }
            </style>
        </head>
        <body>
            <h2>Search Results</h2>
            <p>Count: ${results.length}</p>
            ${tableClone.outerHTML}
        </body>
        </html>
    `;
    
    const blob = new Blob([htmlContent], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "search_results.html";
    a.click();
}

function downloadExcel() {
    const dataForSheet = results.map(row => row.map(cell => cell.text));
    
    const headerRow = outputCols.map(idx => headers[idx]);
    if (document.getElementById("createNumbers").checked) {
        headerRow.push("Extracted Numbers");
    }
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headerRow, ...dataForSheet]);
    XLSX.utils.book_append_sheet(wb, ws, "Results");
    XLSX.writeFile(wb, "search_results.xlsx");
}
</script>
</body>
</html>
